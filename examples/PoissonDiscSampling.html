<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poisson Disc Sampling</title>
</head>
<body>
  <h1>Poisson Disc Sampling</h1>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

  <script>
    const attempts = 30;
    const radius = 20;
    const count = 400;
    const cellWidth = radius / Math.sqrt(2); // 2 dimensions

    const grid = [];
    const activePoints = [];

    let gridColumns, gridRows;
    
    function setup() {
      createCanvas(600, 600);
      background(55);
      strokeWeight(4);

      // initialize grid
      gridColumns = floor(width / cellWidth);
      gridRows = floor(height / cellWidth);

      grid.length = gridColumns * gridRows;
      grid.fill(-1);

      // get 1st random point
      const x = random(width);
      const y = random(height);
      const i = floor(x / cellWidth);
      const j = floor(y / cellWidth);
      const position = createVector(x, y);
      const cellIndex = i + j * gridColumns;

      // add point to grid arrays
      grid[cellIndex] = position;
      activePoints.push(position);
    }

    function draw() {
      background(0);

      if (activePoints.length > 0) {
        const randomPointIndex = random(activePoints.length);
        const position = activePoints[randomPointIndex];
        let pointFounded = false;

        for (let n = 0; n < attempts; n++) {
          // generate random point
          const candidate = p5.Vector.random2D();
          const magnitude = random(radius, radius * 2);

          candidate.setMag(magnitude);
          candidate.add(position);

          // get point index in grid
          const columnIndex = floor(candidate.x / cellWidth);
          const rowIndex = floor(candidate.y / cellWidth);

          // check points around
          let isGoodPoint = true; // the candidate is far enough from neighbors
          for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
              const neighborIndex = (columnIndex + i) + ((rowIndex + j) * gridColumns);
              const neighborPoint = grid[neighborIndex];
              if (neighborPoint === -1) continue;

              const distanceBetweenPoints = p5.Vector.dist(candidate, neighborPoint);
              if (distanceBetweenPoints < radius) {
                isGoodPoint = false;
              } 
            }
          }
          
          if (isGoodPoint) {
            // add new point
            grid[columnIndex + rowIndex * gridColumns] = candidate;
            activePoints.push(candidate);
            break;
          }
        }

        if (!pointFounded) {
          activePoints.splice(randomPointIndex, 1);
        }
      }

      for (let i = 0; i < grid.length; i++) {
        if (grid[i] === -1) continue;

        stroke(255);
        strokeWeight(10);
        point(grid[i].x, grid[i].y);
      }

      for (let i = 0; i < activePoints.length; i++) {
        stroke(255, 0, 255);
        strokeWeight(10);
        point(activePoints[i].x, activePoints[i].y);
      }
    }
  </script>
</body>
</html>